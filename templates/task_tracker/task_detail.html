{% extends 'base.html' %}
{% block content %}
{% load custom_tag %}
{% load static %}

<h2>{{ task.title }}</h2>
<p>Status: 
    <span class="status-label {{ task.status }}">
        {{ task.get_status_display }}
    </span>
</p>

<p>Creator: {{ task.creator }}</p>
<p class="task-desc">{{ task.description }}</p>

{% if request.user == task.creator %}
    <form method="post" action="{% url 'task-update-status' task.pk %}" style="margin-top:15px;">
        {% csrf_token %}
        <label for="status">–°—Ç–∞—Ç—É—Å:</label>
        <select name="status" id="status">
            <option value="todo" {% if task.status == "todo" %}selected{% endif %}>To Do</option>
            <option value="in_progress" {% if task.status == "in_progress" %}selected{% endif %}>In Progress</option>
            <option value="done" {% if task.status == "done" %}selected{% endif %}>Done</option>
        </select>
        <button type="submit" class="status-btn">–ò–∑–º–µ–Ω–∏—Ç—å</button>
    </form>
{% endif %}

{% if request.user == task.creator %}
    <form method="post" action="{% url 'task-delete' task.pk %}" onsubmit="return confirm('–¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?');" style="margin-top:15px;">
        {% csrf_token %}
        <button type="submit" class="delete-task-btn">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É</button>
    </form>
{% endif %}



<h2>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏:</h2>

<div class="comments">
    {% for comment in task.comments.all %}
    <div class="comment">
        <div class="comment-author">
            {{ comment.author.username }}
        </div>
        <div class="comment-content">
            {{ comment.content }}
            {% if comment.media %}
                <div>
                    {% if comment.media.url|endswith:'.jpg' or comment.media.url|endswith:'.png' or comment.media.url|endswith:'.jpeg' %}
                        <img src="{{ comment.media.url }}" style="max-width: 500px;">
                    {% elif comment.media.url|endswith:'mp4' %}
                        <video width="320" height="240" controls>
                            <source src="{{ comment.media.url }}" type="video/mp4">
                        </video>
                    {% else %}
                        <a href="{{ comment.media.url }}">–°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª</a>
                    {% endif %}
                </div>
            {% endif %}
        </div>

        <!-- –ü–æ–ª–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∫—Ä—ã—Ç–æ–µ -->
        <div class="comment-edit-form" style="display:none;">
            <textarea class="edit-content">{{ comment.content }}</textarea>
            <div class="edit-buttons">
                <button class="save-edit-btn" data-url="{% url 'comment-update' comment.pk %}">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class="cancel-edit-btn">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>


        <div class="comment-actions">
            <span class="edit-comment-btn" data-author-id="{{ comment.author.id }}">–ò–∑–º–µ–Ω–∏—Ç—å</span>
            <span class="delete-comment-btn" data-url="{% url 'comment-delete' comment.pk %}">√ó</span>
        </div>
    </div>
    {% empty %}
    <p>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ–∫–∞ —á—Ç–æ –Ω–µ—Ç...</p>
    {% endfor %}
</div>

<div class="add-comment">
    <h4>–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</h4>
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        
        {{ comment_form.non_field_errors }}
    
        <div class="form-field">
            {{ comment_form.content.errors }}
            {{ comment_form.content }}
        </div>
    
        <div class="form-field">
            {{ comment_form.media.errors }}
            {{ comment_form.media }}
        </div>
    
        <button type="submit">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
    </form>
    
</div>

<script src="{% static 'js/comment_delete_confirm.js' %}"></script>
<script src="{% static 'js/comment_edit.js' %}"></script>

{% endblock %}
